const db = require('../models');
const { ValidationError } = require('sequelize');

// Validation function
const validateVHISubmission = (data) => {
  const errors = [];
  
  if (!data.userId) errors.push('userId is required');
  if (!data.sessionId) errors.push('sessionId is required');
  if (!data.functionalScores) errors.push('functionalScores is required');
  if (!data.physicalScores) errors.push('physicalScores is required');
  if (!data.emotionalScores) errors.push('emotionalScores is required');
  
  // Validate scores structure
  if (data.functionalScores && Object.keys(data.functionalScores).length !== 10) {
    errors.push('functionalScores must contain exactly 10 questions');
  }
  if (data.physicalScores && Object.keys(data.physicalScores).length !== 10) {
    errors.push('physicalScores must contain exactly 10 questions');
  }
  if (data.emotionalScores && Object.keys(data.emotionalScores).length !== 10) {
    errors.push('emotionalScores must contain exactly 10 questions');
  }
  
  // Validate score values
  const validateScoreValues = (scores, prefix) => {
    for (const [key, value] of Object.entries(scores)) {
      if (typeof value !== 'number' || value < 0 || value > 4) {
        errors.push(`${prefix}.${key} must be a number between 0 and 4`);
      }
    }
  };
  
  if (data.functionalScores) validateScoreValues(data.functionalScores, 'functionalScores');
  if (data.physicalScores) validateScoreValues(data.physicalScores, 'physicalScores');
  if (data.emotionalScores) validateScoreValues(data.emotionalScores, 'emotionalScores');
  
  return errors;
};

exports.submitVHI = async (req, res, next) => {
  try {
    console.log('๐ฅ Received VHI submission:', JSON.stringify(req.body, null, 2));
    
    const { userId, sessionId, functionalScores, physicalScores, emotionalScores, language, durationMinutes } = req.body;

    // Validate required fields
    const validationErrors = validateVHISubmission(req.body);
    if (validationErrors.length > 0) {
      console.log('โ VHI validation failed:', validationErrors);
      return res.status(400).json({
        success: false,
        message: "Invalid submission data",
        errors: validationErrors
      });
    }

    // Validate language
    const validLanguages = ['english', 'malayalam'];
    const assessmentLanguage = language && validLanguages.includes(language) ? language : 'english';

    // Calculate subscores and total score
    const functionalSubscore = Object.values(functionalScores).reduce((a, b) => a + b, 0);
    const physicalSubscore = Object.values(physicalScores).reduce((a, b) => a + b, 0);
    const emotionalSubscore = Object.values(emotionalScores).reduce((a, b) => a + b, 0);
    const totalScore = functionalSubscore + physicalSubscore + emotionalSubscore;

    console.log('๐ Calculated scores:', {
      functionalSubscore,
      physicalSubscore,
      emotionalSubscore,
      totalScore
    });

    // Check if VHI model exists
    if (!db.VHI) {
      console.error('โ VHI model not found in database models');
      return res.status(500).json({
        success: false,
        message: "Database configuration error: VHI model not found"
      });
    }

    // Create record
    const record = await db.VHI.create({
      userId: parseInt(userId),
      sessionId,
      functionalScores,
      physicalScores,
      emotionalScores,
      totalScore,
      functionalSubscore,
      physicalSubscore,
      emotionalSubscore,
      language: assessmentLanguage,
      durationMinutes: durationMinutes || 0,
      dateCompleted: new Date()
    });

    console.log('โ VHI record created successfully:', record.id);

    return res.status(201).json({
      success: true,
      message: "VHI assessment saved successfully",
      data: {
        id: record.id,
        totalScore,
        functionalSubscore,
        physicalSubscore,
        emotionalSubscore,
        language: record.language
      }
    });

  } catch (error) {
    console.error("โ Error saving VHI assessment:", error);
    console.error("โ Error stack:", error.stack);
    
    // Handle Sequelize validation errors
    if (error.name === 'SequelizeValidationError') {
      const errors = error.errors.map(err => ({
        field: err.path,
        message: err.message
      }));
      
      return res.status(400).json({
        success: false,
        message: "Validation error",
        errors
      });
    }
    
    // Handle Sequelize database errors
    if (error.name === 'SequelizeDatabaseError') {
      console.error("โ Database error details:", error.original);
      return res.status(500).json({
        success: false,
        message: "Database error occurred",
        error: process.env.NODE_ENV === 'development' ? error.message : undefined
      });
    }

    // Handle foreign key constraint errors
    if (error.name === 'SequelizeForeignKeyConstraintError') {
      return res.status(400).json({
        success: false,
        message: "Referenced user does not exist",
        error: process.env.NODE_ENV === 'development' ? error.message : undefined
      });
    }
    
    // Handle other errors
    return res.status(500).json({
      success: false,
      message: "Server error while saving VHI assessment",
      error: process.env.NODE_ENV === 'development' ? error.message : undefined
    });
  }
};

exports.getVHIHistory = async (req, res) => {
  try {
    const { userId } = req.params;
    const { language } = req.query;

    console.log(`๐ฅ Fetching VHI history for user ${userId}, language: ${language}`);

    let whereClause = { userId: parseInt(userId) };
    if (language) {
      whereClause.language = language;
    }

    const assessments = await db.VHI.findAll({
      where: whereClause,
      order: [['dateCompleted', 'DESC']],
      attributes: [
        'id', 
        'totalScore', 
        'functionalSubscore', 
        'physicalSubscore', 
        'emotionalSubscore', 
        'dateCompleted',
        'language',
        'durationMinutes'
      ]
    });

    console.log(`โ Found ${assessments.length} VHI assessments`);

    return res.status(200).json({
      success: true,
      data: assessments
    });
  } catch (error) {
    console.error("โ Error fetching VHI history:", error);
    return res.status(500).json({
      success: false,
      message: "Server error while fetching VHI history",
      error: process.env.NODE_ENV === 'development' ? error.message : undefined
    });
  }
};

exports.getVHIQuestions = async (req, res) => {
  try {
    const { language } = req.params;
    
    console.log(`๐ฅ Fetching VHI questions for language: ${language}`);
    
    const validLanguages = ['english', 'malayalam'];
    const questionLanguage = validLanguages.includes(language) ? language : 'english';
    
    let questions;
    
    if (questionLanguage === 'malayalam') {
      questions = {
        functional: [
          { number: 1, text: "เดเดจเตเดฑเต เดถเดฌเตเดฆเด เดฎเตเดฒเด เดเดณเตเดเตพเดเตเดเต เดเดจเตเดจเต เดเตเตพเดเตเดเดพเตป เดฌเตเดฆเตเดงเดฟเดฎเตเดเตเดเต เดเดฃเตเดเดพเดเตเดจเตเดจเต." },
          { number: 2, text: "เดเดเตเดเดชเตเดชเดพเดเต เดเดณเตเดณ เดฎเตเดฑเดฟเดฏเดฟเตฝ เดเดณเตเดเตพเดเตเดเต เดเดจเตเดจเต เดฎเดจเดธเตเดธเดฟเดฒเดพเดเตเดเดพเตป เดฌเตเดฆเตเดงเดฟเดฎเตเดเตเดเต เดเดฃเตเดเดพเดเตเดจเตเดจเต." },
          { number: 3, text: "เดเดจเตเดฑเต เดถเดฌเตเดฆ เดชเตเดฐเดถเตเดจเดเตเดเตพ เดตเตเดฏเดเตเดคเดฟเดชเดฐเดฎเดพเดฏเตเด เดธเดพเดฎเตเดนเดฟเดเดตเตเดฎเดพเดฏ เดเตเดตเดฟเดคเดคเตเดคเต เดชเดฐเดฟเดฎเดฟเดคเดชเตเดชเตเดเตเดคเตเดคเตเดจเตเดจเต." },
          { number: 4, text: "เดเดจเตเดฑเต เดถเดฌเตเดฆเด เดฎเตเดฒเด เดธเดเดญเดพเดทเดฃเดเตเดเดณเดฟเตฝ เดจเดฟเดจเตเดจเต เดเดดเดฟเดตเดพเดเตเดเดชเตเดชเตเดเตเดจเตเดจเดคเดพเดฏเดฟ เดเดพเตป เดเดจเตเดญเดตเดฟเดเตเดเตเดจเตเดจเต." },
          { number: 5, text: "เดเดจเตเดฑเต เดถเดฌเตเดฆ เดชเตเดฐเดถเตเดจเด เดฎเตเดฒเด เดเดณเตเดเดณเตเดเต เดธเดฎเตเดนเดเตเดเตพ เดเดดเดฟเดตเดพเดเตเดเดพเตป เดเดพเตป เดจเดฟเตผเดฌเดจเตเดงเดฟเดคเดจเดพเดเตเดจเตเดจเต." },
          { number: 6, text: "เดฎเตเดเดพเดฎเตเดเด เดธเดเดธเดพเดฐเดฟเดเตเดเตเดฎเตเดชเตเตพ เดเดณเตเดเตพ เดเดจเตเดจเตเดเต เดตเตเดฃเตเดเตเด เดชเดฑเดฏเดพเตป เดเดตเดถเตเดฏเดชเตเดชเตเดเตเดจเตเดจเต." },
          { number: 7, text: "เดเดพเตป เดเดเตเดฐเดนเดฟเดเตเดเตเดจเตเดจเดคเดฟเดจเตเดเตเดเดพเตพ เดเตเดฑเดเตเดเต เดคเดตเดฃ เดฎเดพเดคเตเดฐเดฎเต เดเตเดฒเดฟเดซเตเตบ เดเดชเดฏเตเดเดฟเดเตเดเตเดจเตเดจเตเดณเตเดณเต." },
          { number: 8, text: "เดเดจเตเดฑเต เดถเดฌเตเดฆ เดชเตเดฐเดถเตเดจเด เดเตเดเตเดเดฌเดพเดเดเดเตเดเดณเตเด เดธเตเดนเตเดคเตเดคเตเดเตเดเดณเตเดฎเดพเดฏเตเดณเตเดณ เดเดถเดฏเดตเดฟเดจเดฟเดฎเดฏเดคเตเดคเต เดชเดฐเดฟเดฎเดฟเดคเดชเตเดชเตเดเตเดคเตเดคเตเดจเตเดจเต." },
          { number: 9, text: "เดเดจเตเดฑเต เดถเดฌเตเดฆเด เดฎเตเดฒเด เดเดพเตป เดตเตเดเดฒเตเดฏเด เดเดจเตเดญเดตเดฟเดเตเดเตเดจเตเดจเต." },
          { number: 10, text: "เดเดจเตเดฑเต เดถเดฌเตเดฆ เดชเตเดฐเดถเตเดจเด เดฎเตเดฒเด เดตเตเดเดพเดฐเดฟเดเดฎเดพเดฏเดฟ เดเดจเตเดจเตเดคเตเดคเดจเตเดจเต เดชเตเดฐเดเดเดฟเดชเตเดชเดฟเดเตเดเดพเตป เดฌเตเดฆเตเดงเดฟเดฎเตเดเตเดเต เดเดฃเตเดเดพเดเตเดจเตเดจเต." }
        ],
        physical: [
          { number: 11, text: "เดธเดเดธเดพเดฐเดฟเดเตเดเตเดฎเตเดชเตเตพ เดเดจเดฟเดเตเดเต เดถเตเดตเดพเดธเด เดฎเตเดเตเดเตเดจเตเดจเต." },
          { number: 12, text: "เดฆเดฟเดตเดธเด เดฎเตเดดเตเดตเตป เดเดจเตเดฑเต เดถเดฌเตเดฆเดคเตเดคเดฟเดจเตเดฑเต เดถเดฌเตเดฆเด เดตเตเดฏเดคเตเดฏเดพเดธเดชเตเดชเตเดเตเดจเตเดจเต." },
          { number: 13, text: "เดเดณเตเดเตพเดเตเดเต เดเดจเตเดจเต เดเตเตพเดเตเดเดพเตป เดฌเตเดฆเตเดงเดฟเดฎเตเดเตเดเต เดเดฃเตเดเดพเดเตเดจเตเดจเต." },
          { number: 14, text: "เดธเดเดธเดพเดฐเดฟเดเตเดเดพเตป เดเดจเดฟเดเตเดเต เดตเดณเดฐเตเดฏเดงเดฟเดเด เดชเดฐเดฟเดถเตเดฐเดฎเด เดเตเดฏเตเดฏเตเดฃเตเดเดฟเดตเดฐเตเดจเตเดจเต." },
          { number: 15, text: "เดเดจเตเดฑเต เดถเดฌเตเดฆเด เดฆเตเตผเดฌเดฒเดฎเต เดถเตเดตเดพเดธเดฎเดฟเดเตเดคเดฎเต เดเดฃเต." },
          { number: 16, text: "เดธเดเดธเดพเดฐเดฟเดเตเดเตเดฎเตเดชเตเตพ เดตเตเดฆเดจเดฏเต เดเดธเตเดตเดธเตเดฅเดคเดฏเต เดเดพเตป เดเดจเตเดญเดตเดฟเดเตเดเตเดจเตเดจเต." },
          { number: 17, text: "เดธเดเดธเดพเดฐเดฟเดเตเดเตเดฎเตเดชเตเตพ เดเดจเตเดฑเต เดถเดฌเตเดฆเด เดเดเดฏเตเดเตเดเต เดจเดฟเดฒเดเตเดเตเดจเตเดจเต." },
          { number: 18, text: "เดถเดฌเตเดฆเด เดเดฃเตเดเดพเดเตเดเดพเตป เดเดพเตป เดฌเดฒเดชเตเดฐเดฏเตเดเด เดเตเดฏเตเดฏเตเดฃเตเดเดฟเดตเดฐเตเดจเตเดจเดคเดพเดฏเดฟ เดคเตเดจเตเดจเตเดจเตเดจเต." },
          { number: 19, text: "เดเดจเตเดฑเต เดถเดฌเตเดฆเด เดชเตเดฐเตเดเดเตเดฑเตเดฑเต เดเตเดฏเตเดฏเดพเตป เดเดจเดฟเดเตเดเต เดฌเตเดฆเตเดงเดฟเดฎเตเดเตเดเดพเดฃเต." },
          { number: 20, text: "เดเดจเตเดฑเต เดถเดฌเตเดฆเด เดเตผเดถเดจเดฎเต เดชเดฐเตเดเตเดเดจเต เดเดฃเต." }
        ],
        emotional: [
          { number: 21, text: "เดเดจเตเดฑเต เดถเดฌเตเดฆเด เดฎเตเดฒเด เดฎเดฑเตเดฑเตเดณเตเดณเดตเดฐเตเดเต เดธเดเดธเดพเดฐเดฟเดเตเดเตเดฎเตเดชเตเตพ เดเดพเตป เดชเดฟเดฐเดฟเดฎเตเดฑเตเดเตเดเด เดเดจเตเดญเดตเดฟเดเตเดเตเดจเตเดจเต." },
          { number: 22, text: "เดเดจเตเดฑเต เดถเดฌเตเดฆเดคเตเดคเดพเตฝ เดเดณเตเดเตพเดเตเดเต เดถเดฒเตเดฏเด เดคเตเดจเตเดจเตเดจเตเดจเต." },
          { number: 23, text: "เดฎเดฑเตเดฑเตเดณเตเดณเดตเตผ เดเดจเตเดฑเต เดถเดฌเตเดฆ เดชเตเดฐเดถเตเดจเด เดฎเดจเดธเตเดธเดฟเดฒเดพเดเตเดเตเดจเตเดจเดฟเดฒเตเดฒเตเดจเตเดจเต เดเดพเตป เดเดฃเตเดเตเดคเตเดคเตเดจเตเดจเต." },
          { number: 24, text: "เดเดจเตเดฑเต เดถเดฌเตเดฆ เดชเตเดฐเดถเตเดจเด เดเดจเตเดจเต เดเดธเตเดตเดธเตเดฅเดจเดพเดเตเดเตเดจเตเดจเต." },
          { number: 25, text: "เดเดจเตเดฑเต เดถเดฌเตเดฆ เดชเตเดฐเดถเตเดจเด เดฎเตเดฒเด เดเดพเตป เดเตเดฑเดเตเดเต เดธเดพเดฎเตเดนเดฟเดเดฎเดพเดเตเดจเตเดจเต." },
          { number: 26, text: "เดเดจเตเดฑเต เดถเดฌเตเดฆเด เดเดจเตเดจเต เดเดชเตเดฐเดพเดชเตเดคเดจเดพเดฃเตเดจเตเดจเต เดคเตเดจเตเดจเดฟเดเตเดเตเดจเตเดจเต." },
          { number: 27, text: "เดเดณเตเดเตพ เดเดจเตเดจเตเดเต เดตเตเดฃเตเดเตเด เดชเดฑเดฏเดพเตป เดเดตเดถเตเดฏเดชเตเดชเตเดเตเดฎเตเดชเตเตพ เดเดจเดฟเดเตเดเต เดถเดฒเตเดฏเด เดคเตเดจเตเดจเตเดจเตเดจเต." },
          { number: 28, text: "เดเดณเตเดเตพ เดเดจเตเดจเตเดเต เดตเตเดฃเตเดเตเด เดชเดฑเดฏเดพเตป เดเดตเดถเตเดฏเดชเตเดชเตเดเตเดฎเตเดชเตเตพ เดเดจเดฟเดเตเดเต เดฒเดเตเด เดคเตเดจเตเดจเตเดจเตเดจเต." },
          { number: 29, text: "เดเดจเตเดฑเต เดถเดฌเตเดฆเด เดเดจเตเดจเต เดจเดฟเดฐเดพเดถเดจเดพเดเตเดเตเดจเตเดจเต." },
          { number: 30, text: "เดเดจเตเดฑเต เดถเดฌเตเดฆ เดชเตเดฐเดถเตเดจเด เดฎเตเดฒเด เดเดพเตป เดตเดฟเดทเดพเดฆเด เดเดจเตเดญเดตเดฟเดเตเดเตเดจเตเดจเต." }
        ]
      };
    } else {
      questions = {
        functional: [
          { number: 1, text: "My voice makes it difficult for people to hear me." },
          { number: 2, text: "People have difficulty understanding me in a noisy room." },
          { number: 3, text: "My voice difficulties restrict personal and social life." },
          { number: 4, text: "I feel left out of conversations because of my voice." },
          { number: 5, text: "My voice problem causes me to avoid groups of people." },
          { number: 6, text: "People ask me to repeat myself when speaking face-to-face." },
          { number: 7, text: "I use the telephone less often than I would like." },
          { number: 8, text: "My voice problem limits my communication with family and friends." },
          { number: 9, text: "I feel handicapped because of my voice." },
          { number: 10, text: "My voice problem makes it difficult for me to express myself emotionally." }
        ],
        physical: [
          { number: 11, text: "I run out of air when I talk." },
          { number: 12, text: "The sound of my voice varies throughout the day." },
          { number: 13, text: "People have difficulty hearing me." },
          { number: 14, text: "I use a great deal of effort to speak." },
          { number: 15, text: "My voice is weak or breathy." },
          { number: 16, text: "I experience pain or discomfort when speaking." },
          { number: 17, text: "My voice 'gives out' on me in the middle of speaking." },
          { number: 18, text: "I feel as though I have to strain to produce voice." },
          { number: 19, text: "I find it difficult to project my voice." },
          { number: 20, text: "My voice is hoarse or rough." }
        ],
        emotional: [
          { number: 21, text: "I am tense when talking with others because of my voice." },
          { number: 22, text: "People seem irritated by my voice." },
          { number: 23, text: "I find other people don't understand my voice problem." },
          { number: 24, text: "My voice problem upsets me." },
          { number: 25, text: "I am less outgoing because of my voice problem." },
          { number: 26, text: "My voice makes me feel incompetent." },
          { number: 27, text: "I feel annoyed when people ask me to repeat." },
          { number: 28, text: "I feel embarrassed when people ask me to repeat." },
          { number: 29, text: "My voice makes me feel frustrated." },
          { number: 30, text: "I am depressed because of my voice problem." }
        ]
      };
    }

    console.log(`โ Returning VHI questions in ${questionLanguage}`);

    return res.status(200).json({
      success: true,
      data: {
        language: questionLanguage,
        questions
      }
    });
  } catch (error) {
    console.error("โ Error fetching VHI questions:", error);
    return res.status(500).json({
      success: false,
      message: "Server error while fetching VHI questions",
      error: process.env.NODE_ENV === 'development' ? error.message : undefined
    });
  }
};